<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 头部内容保持不变 -->
</head>
<body>
    <!-- 主体内容保持不变 -->

    <script>
        // 硬编码的GitHub配置
        const githubConfig = {
            token: 'cmd', // 实际应用中应避免硬编码敏感信息
            repo: 's12553/THC',
            branch: 'main'
        };

        // 添加SYNC_TOKEN常量
        const SYNC_TOKEN = 'secure-sync-token';

        // ... 其他代码保持不变 ...

        // 处理用户输入
        function handleCommand(command) {
            addOutput(command, true);
            
            if (!currentUser) {
                // 登录处理
                if (command.toLowerCase() === 'login') {
                    addOutput('Enter user credentials (format: username | password)');
                } 
                // 添加对sync命令的支持（不需要登录）
                else if (command.toLowerCase().startsWith('sync')) {
                    handleSyncCommand(command);
                }
                else if (usersData[command]) {
                    // ... 登录处理代码保持不变 ...
                } else {
                    addOutput('<div class="error">ERROR: Invalid credentials or command</div>');
                    addOutput('<div>Available commands: LOGIN or SYNC [token]</div>');
                }
            } else {
                // 命令处理
                const parts = command.split(' ');
                const cmd = parts[0].toLowerCase();
                
                if (cmd === 'help') {
                    // ... help命令处理保持不变 ...
                } else if (cmd === 'access') {
                    // ... access命令处理保持不变 ...
                } else if (cmd === 'logout') {
                    // ... logout命令处理保持不变 ...
                } else if (cmd === 'clear') {
                    // ... clear命令处理保持不变 ...
                } else if (cmd === 'add' && parts[1]?.toLowerCase() === 'access') {
                    // ... add access命令处理保持不变 ...
                } else if (cmd === 'list' && parts[1]?.toLowerCase() === 'articles') {
                    // ... list articles命令处理保持不变 ...
                } else if (cmd === 'sync') {
                    handleSyncCommand(command);
                } else {
                    addOutput('<div class="error">ERROR: Unknown command</div>');
                    addOutput('<div>Type HELP for available commands</div>');
                }
            }
            
            // 清空输入框并重新聚焦
            inputField.value = '';
        }

        // 处理同步命令的公共函数
        function handleSyncCommand(command) {
            const parts = command.split(' ');
            const token = parts.length > 1 ? parts[1] : null;
            
            if (!token) {
                addOutput('<div class="error">ERROR: Missing sync token</div>');
                addOutput('<div>Usage: SYNC [token]</div>');
                return;
            }
            
            if (token !== SYNC_TOKEN) {
                addOutput('<div class="error">ERROR: Invalid sync token</div>');
                return;
            }
            
            // 创建同步状态显示
            const syncStatus = document.createElement('div');
            syncStatus.className = 'sync-status syncing';
            syncStatus.innerHTML = `
                <div class="icon">↻</div>
                <div class="details">
                    <div>Syncing data with GitHub repository...</div>
                    <div class="sync-progress">
                        <div class="sync-progress-bar" id="syncProgressBar"></div>
                    </div>
                </div>
            `;
            outputDiv.appendChild(syncStatus);
            outputDiv.scrollTop = outputDiv.scrollHeight;
            
            // 模拟进度条
            const progressBar = document.getElementById('syncProgressBar');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = `${progress}%`;
                if (progress >= 100) clearInterval(interval);
            }, 300);
            
            // 确定同步类型
            const syncType = command.toLowerCase().includes('full') ? 'full' : 'normal';
            
            // 执行同步
            setTimeout(async () => {
                try {
                    let articlesResult, usersResult;
                    
                    if (syncType === 'full') {
                        // 强制全量同步
                        articlesResult = await syncData('articles');
                        usersResult = await syncData('users');
                    } else {
                        // 正常同步
                        articlesResult = await syncData('articles');
                        usersResult = await syncData('users');
                    }
                    
                    syncStatus.className = 'sync-status success';
                    syncStatus.innerHTML = `
                        <div class="icon">✓</div>
                        <div class="details">
                            <div>Synchronization complete!</div>
                            <div>${articlesResult}</div>
                            <div>${usersResult}</div>
                        </div>
                        <div class="sync-actions">
                            <div class="sync-btn" onclick="handleCommand('SYNC ${SYNC_TOKEN}')">Sync Again</div>
                            <div class="sync-btn full-sync" onclick="handleCommand('SYNC ${SYNC_TOKEN} FULL')">Full Sync</div>
                        </div>
                    `;
                } catch (e) {
                    syncStatus.className = 'sync-status error';
                    syncStatus.innerHTML = `
                        <div class="icon">✗</div>
                        <div class="details">
                            <div>Synchronization failed!</div>
                            <div>${e.message}</div>
                        </div>
                        <div class="sync-actions">
                            <div class="sync-btn" onclick="handleCommand('SYNC ${SYNC_TOKEN}')">Retry</div>
                        </div>
                    `;
                }
            }, 3000);
        }

        // ... 其他代码保持不变 ...
    </script>
</body>
</html>
